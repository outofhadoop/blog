[TOC]

# 事件循环机制（Event Loop）

## 主线程

主线程只有一个，主线程运行时会产生**堆(heap)**和**栈(stack)**，栈在运行的时候会调用外部API(DOM相关api、ajax相关、setTimeout等)；主线程执行栈执行完毕后，就会去读取**任务队列**，若任务执行完毕就会放到执行栈中执行。

## 任务队列

任务可以分为**同步任务**和**异步任务**，任务队列中的任务可以认为是异步任务，执行栈中的任务可以认为是同步任务。


## 与任务队列有关的方法

### 宏任务（macro-task）

以下方法会创建宏任务：

1. setTimeout

立即计时，在计时结束后在宏任务队列尾部添加事件。

2. setInterval

立即计时，每隔一个时间周期在宏任务队列尾部添加事件。

3. sertImmediate (NodeJS API)

立即在宏任务队列尾部添加事件。

4.  I/O

5. UI rendering

### 微任务

微任务队列的优先级高于宏任务

以下方法会创建微任务：

1. process.nextTick (NodeJS API)

可以理解为直接把该任务放置在执行栈末尾，也可以理解为在微任务队列头部添加一个任务。

2. Promise

3. MutationObserver
4. queueMicrotask (NodeJS API)



## 总结

事件循环在主线程外会有宏任务队列和微任务队列，宏任务优先级低于微任务，当主线程执行栈执行完毕后，会把微任务队列中的任务放入执行栈，微任务队列所有任务执行完毕后再去宏任务队列中把宏任务放入执行栈中执行，这个流程便是一次事件循环。